#!/bin/zsh

# Get staged changes
diff=$(git diff --cached)
if [[ -z "$diff" ]]; then
    echo "No staged changes found. Use git add to stage changes first."
    exit 1
fi

# Count total commits in the project
commit_count=$(git rev-list --count HEAD 2>/dev/null || echo "0")

# Build prompt based on commit history
if [[ $commit_count -gt 2 ]]; then
    # Project has established commit history - match existing style
    examples=$(git log --oneline -20)
    prompt="Analyze this git diff and generate a concise commit message in JSON format: {\"message\": \"your commit message here\"}. Match the tone and style of these recent commit messages:

$examples

Current diff changes:"
else
    # New project - provide standard style guidance
    prompt="Analyze this git diff and generate a conventional commit message in JSON format: {\"message\": \"type(scope): description\"}. Use minimal output, only return the JSON.

Current diff changes:"
fi

# Generate commit message using Claude
# Use ANTHROPIC_DEFAULT_HAIKU_MODEL if set, otherwise haiku
# Users can override with CLAUDE_MODEL environment variable
model="${CLAUDE_MODEL:-${ANTHROPIC_DEFAULT_HAIKU_MODEL:-haiku}}"
message=$(echo -e "$diff\n\n$prompt" | claude --model "$model" -p)

# Extract the message from JSON
commit_msg=$(echo "$message" | sed -n 's/.*"message"[^0-9A-Za-z]*"\([^"]*\)".*/\1/p')

# Create the commit if we got a valid message
if [[ -n "$commit_msg" ]]; then
    git commit -m "$commit_msg"
else
    echo "Failed to generate commit message"
    exit 1
fi
