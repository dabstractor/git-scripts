#!/bin/zsh

# -------------------------------------------------------------------------
# ERROR HANDLER (RESCUE PROTOCOL)
# -------------------------------------------------------------------------
handle_error() {
    if [[ -n "$TREE_SHA" && -z "$NEW_COMMIT_SHA" ]]; then
        echo ""
        echo "❌ Commit generation failed."
        echo "------------------------------------------------------------"
        echo "Your files were safely snapshotted before generation."
        echo "Tree ID: $TREE_SHA"
        echo ""
        echo "To commit the originally staged files manually, run:"
        if [[ -n "$PARENT_SHA" ]]; then
            echo "  git commit-tree -p $PARENT_SHA -m \"Your manual message\" $TREE_SHA | xargs git update-ref HEAD"
        else
            echo "  git commit-tree -m \"Your manual message\" $TREE_SHA | xargs git update-ref HEAD"
        fi
        echo "------------------------------------------------------------"
    fi
    exit 1
}

trap 'handle_error' INT TERM

# -------------------------------------------------------------------------
# 1. IMMEDIATE SNAPSHOT (PLUMBING)
# -------------------------------------------------------------------------
TREE_SHA=$(git write-tree)
if [[ $? -ne 0 ]]; then
    echo "Failed to write tree. Make sure you have staged changes."
    exit 1
fi

PARENT_SHA=$(git rev-parse HEAD 2>/dev/null)

diff=$(git diff --cached)
if [[ -z "$diff" ]]; then
    echo "No staged changes found."
    exit 1
fi

# -------------------------------------------------------------------------
# 2. PREPARE PROMPT & JSON INSTRUCTIONS
# -------------------------------------------------------------------------
commit_count=$(git rev-list --count HEAD 2>/dev/null || echo "0")

# Strict instruction: No internal double quotes to allow safe regex parsing
json_instruction="Return valid JSON only. No markdown, no XML.
Format: {\"commit_message\": \"<message>\"}
IMPORTANT: Do NOT use double quotes (\") inside the message text. Use single quotes instead if needed."

if [[ $commit_count -gt 1 ]]; then
    examples=$(git log --oneline -20 | cut -d' ' -f2-)
    system_prompt="You are a commit message generator.
$json_instruction

Match this exact style for the message content:
$examples

Target exactly 50 characters (~7 words). Do not exceed by more than 2 characters."
else
    system_prompt="You are a commit message generator.
$json_instruction

Target 50 characters (~7 words). Format: type(scope): description"
fi

prompt="Generate a commit message for these changes:"

# -------------------------------------------------------------------------
# 3. ASYNC GENERATION LOOP (WITH RETRY)
# -------------------------------------------------------------------------
if [[ -n "$CLAUDE_COMMAND" ]]; then
    eval "claude_cmd=($CLAUDE_COMMAND)"
else
    claude_cmd=(claude)
fi
model="${ANTHROPIC_DEFAULT_HAIKU_MODEL:-haiku}"

attempt=1
max_attempts=2
commit_msg=""

while [ $attempt -le $max_attempts ]; do
    if [[ "$VERBOSE" == "1" ]]; then echo "DEBUG: Attempt $attempt of $max_attempts"; fi
    
    # Run the API call
    response=$(printf '%s\n\n%s' "$diff" "$prompt" | "${claude_cmd[@]}" --model "$model" --system-prompt "$system_prompt" -p)
    
    if [[ "$VERBOSE" == "1" ]]; then echo "DEBUG: Raw Response: $response"; fi

    # PARSE JSON USING SED
    # 1. tr -d '\n'     -> Remove newlines to handle multi-line JSON output
    # 2. sed command    -> Capture text between "commit_message": " AND "
    commit_msg=$(echo "$response" | tr -d '\n' | sed -n 's/.*"commit_message"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')

    # Trim whitespace (standard awk fallback for xargs behavior)
    commit_msg=$(echo "$commit_msg" | awk '{$1=$1};1')

    if [[ -n "$commit_msg" ]]; then
        break
    else
        echo "⚠️  Received invalid JSON format. Retrying..."
        prompt="The previous response was not valid JSON. Please output STRICT valid JSON only: {\"commit_message\": \"message_here\"}"
        ((attempt++))
    fi
done

# -------------------------------------------------------------------------
# 4. VALIDATION & FINALIZATION
# -------------------------------------------------------------------------

if [[ -z "$commit_msg" ]]; then
    echo "Error: Failed to extract commit message after $max_attempts attempts."
    handle_error
fi

recent_messages=$(git log --oneline -10 2>/dev/null | cut -d' ' -f2-)
if echo "$recent_messages" | grep -q "^$commit_msg$"; then
    echo "Error: Generated commit message already exists in history: '$commit_msg'"
    handle_error
fi

if [[ -n "$PARENT_SHA" ]]; then
    NEW_COMMIT_SHA=$(git commit-tree -p "$PARENT_SHA" -m "$commit_msg" "$TREE_SHA")
    
    if ! git update-ref HEAD "$NEW_COMMIT_SHA" "$PARENT_SHA"; then
        echo "Error: Could not update HEAD. The branch moved while we were generating."
        exit 1
    fi
else
    NEW_COMMIT_SHA=$(git commit-tree -m "$commit_msg" "$TREE_SHA")
    git update-ref HEAD "$NEW_COMMIT_SHA"
fi

echo "[$NEW_COMMIT_SHA] $commit_msg"
git --no-pager diff-tree --no-commit-id --name-status -r "$NEW_COMMIT_SHA"

trap - INT TERM
